<!DOCTYPE HTML>

<html>

	<head>


		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>

		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/bootstrap-responsive.min.css" rel="stylesheet">
		<link href="css/urmoviereviews.css" rel="stylesheet">
		<link href="css/jquery-ui-1.10.2.custom.min.css" rel="stylesheet">
		

		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.10.2.custom.min.js"></script>

		<script>

		

		//***************************** search bar function ****************************

		function searchMovies(request, response) {
		    console.log(request);
		    $.ajax({
		        url: "http://www.omdbapi.com/?s=" + request['term'] + "&r=JSON",
		        type: "GET",
		        dataType: "json",
		        success: function (data) {
		            var searchArray = data['Search'];
		            var results = [];
		            for(var i = 0; i < searchArray.length; i++) {
		                results.push({label: searchArray[i]['Title']+" ("+searchArray[i]['Year']+")", id: searchArray[i]['imdbID']});
		            }
		            response(results);
		        }
		        
		        }); //End of ajax

		};// End of searchMovies function



		//**************************** Grab individual movie info from OMDBapi.com ************************

		function grabMovieInfo (ui) {
			
			// console.log(ui.item);	

					$.ajax({
			        url: "http://www.omdbapi.com/?i=" + ui.item.id + "&tomatoes=true",
			        type: "GET",
			        dataType: "json",
			        success: function (data) {
			            	console.log(data);
			            	console.log(data.tomatoMeter);
			            	populateMovieInfo(data);

			            }
			 
			        
			        }); //End of ajax

			        $('form').show();
		};



		//****************************** Populate movie info to Form ***************************


		function populateMovieInfo(data) {
			$('#putMovieInfo').html(" ");
			$('#putMovieInfo').append(
				//Hidden input values to send to JSON reviewedMovie object
				'<input type="hidden" id="posterInput" value="'+data.Poster+'">'+
				'<input type="hidden" id="titleInput" value="'+data.Title+'">'+
				'<input type="hidden" id="yearInput" value="'+data.Year+'">'+
				'<input type="hidden" id="ratedInput" value="'+data.Rated+'">'+
				'<input type="hidden" id="lengthInput" value="'+data.Runtime+'">'+
				'<input type="hidden" id="genreInput" value="'+data.Genre+'">'+
				'<input type="hidden" id="releasedInput" value="'+data.Released+'">'+
				'<input type="hidden" id="plotInput" value="'+data.Plot+'">'+
				'<input type="hidden" id="directorInput" value="'+data.Director+'">'+
				'<input type="hidden" id="writerInput" value="'+data.Writer+'">'+
				'<input type="hidden" id="actorsInput" value="'+data.Actors+'">'+

				//This is actually what shows up on the form 
				'<img id="moviePoster" src="'+data.Poster+'"></img>'+
				'<div id="movieInfo"><div id="title">'+data.Title+'</div>' +
				'<div id="year">('+data.Year+')</div>' +
				'<div id="rated">'+data.Rated+'</div>'+
				'<div id="length">'+data.Runtime+'</div>'+
				'<div id="genre">'+data.Genre+'</div>'+
				'<div id="released">'+data.Released+'</div>'+
				'<div id="plot">'+data.Plot+'</div>'+
				'<div id="director">Director: '+data.Director+'</div>'+
				'<div id="writer">Writer: '+data.Writer+'</div>'+
				'<div id="actors">Stars: '+data.Actors+'</div></div>'
				);

		};//End of populateMovieInfo function



		function clearForm() {
			$('#putMovieInfo').html(" ");
			$('input').each(function() {
				$('input').val(' ');
				$('textarea').val(' ');
			});
			$('form').hide();
		};




	//*********************** DOCUMENT.READY STARTS HERE *******************************

		$(document).ready(function() {

			$('form').hide();

			//************************** Popover function call *******************
			$('#movieTable').popover({
		      selector: "a[data-toggle=popover]", html: "true"
		    });



			//************************ Refresh Table Call *******************

			$.ajax({
			url: "backliftapp/movieDatabase",
			type: "GET",
			dataType: "json",
			success: function (data) {
				for(var i = 0; i < data.length; i++) {
					refreshMovieTable(data[i]);
					}
				}

			}); //End of ajax


			//************************ search bar autocomplete (plugin) call ********************


    		$("#testing").autocomplete( { source: searchMovies, delay: 800, select: function(select, ui) {grabMovieInfo(ui);} });




   
   			//************************ Send form data to JSON object on movieDatabase ********************

			$('#submitMovieReview').click(function() {


				var string = $('#review').val();
				var newstring = string.replace(/"/g, '&#34');


				reviewedMovie = {
				poster: $("#posterInput").val(),
				title: $("#titleInput").val(),
				rating: $("#ratedInput").val(),
				runtime: $("#lengthInput").val(),
				yearReleased: $("#yearInput").val(),
				dateWatched: $("#movieDateWatched").val(),
				review: newstring
				};
 

				$.ajax({
					url: "backliftapp/movieDatabase",
					type: "POST",
					dataType: "json",
					data: reviewedMovie,
					success: function (data) {
						addMovieToTable(data);
					}
				});

				
				clearForm();


			}); // End of submitData.click


			$('#cancelMovieReview').click(function() {

				clearForm();

			});

			



			function addMovieToTable (reviewedMovie) {
				$('#movieTable').append(
					'<tr id="'+reviewedMovie.title+'">'+
						'<td><img class="posterThumbnail" src="'+reviewedMovie.poster+'" style="max-height: 40px;"/></td>'+
						'<td>'+
							'<a href="#'+reviewedMovie.title+'" id="movieStuff" data-toggle="popover" '+

								'title data-original-title="'+
									'<img src='+reviewedMovie.poster+'></img>'+
									'<h3>'+reviewedMovie.title+'</h3>'+
									'<h4>('+reviewedMovie.yearReleased+')</h4>" '+

								'data-content="'+
									'<h4>Review:</h4>'+
									'<p>'+reviewedMovie.review+'</p> "'+

							'>'+reviewedMovie.title+''+
							'</a>'+
						'</td>'+
						'<td>?</td><td>'+reviewedMovie.yearReleased+'</td>'+
						'<td>'+reviewedMovie.dateWatched+'</td><td>'+reviewedMovie.rating+'</td>'+
						'<td>'+reviewedMovie.runtime+'</td>'+
						'<td><button id="deleteButton" type="submit" class="btn" onClick="deleteMovie(\'' + reviewedMovie.id + '\')">delete</button></td>'+
					'</tr>'
				)

			};//End of addMovieToTable function


			function refreshMovieTable (reviewedMovie) {
				$(
					'<tr id="'+reviewedMovie.title+'">'+
						'<td><img class="posterThumbnail" src="'+reviewedMovie.poster+'" style="max-height: 40px;"/></td>'+
						'<td>'+
							'<a href="#'+reviewedMovie.title+'" id="movieStuff" data-toggle="popover" '+

								'title data-original-title="'+
									'<img src='+reviewedMovie.poster+'></img>'+
									'<h3>'+reviewedMovie.title+'</h3>'+
									'<h4>('+reviewedMovie.yearReleased+')</h4>" '+

								'data-content="'+
									'<h4>Review:</h4>'+
									'<p>'+reviewedMovie.review+'</p> "'+

							'>'+reviewedMovie.title+''+
							'</a>'+
						'</td>'+
						'<td>?</td><td>'+reviewedMovie.yearReleased+'</td>'+
						'<td>'+reviewedMovie.dateWatched+'</td><td>'+reviewedMovie.rating+'</td>'+
						'<td>'+reviewedMovie.runtime+'</td>'+
						'<td><button id="deleteButton" type="submit" class="btn" onClick="deleteMovie(\'' + reviewedMovie.id + '\')">delete</button></td>'+
					'</tr>'

				).appendTo('#movieTable');

			};

		


			

		});//End of doc.ready function


function deleteMovie (id) {
			  var conf = confirm("Are you sure you want to delete this movie?");
			  if (conf == true) {
			    $.ajax({
			      url: "backliftapp/movieDatabase/" + id,
			      type: "DELETE",
			      dataType: "json",
			      success: function () {
			      	
			      }
			    })
			};
			
	}; // End of deleteMovie

		</script>
	</head>




	<body>

		<div class="container">

			<div class="row>"
				<div class="span12 box">

					<!--Form to Write Ur Review-->
					<label for="testing">Search for A Movie</label>
					<input id="testing">
					<br>
					<br>
					<div id="putMovieInfo">

					</div>

					<form>
			 			<label for="movieDateWatched">Date Watched</label>
			 			<input id="movieDateWatched" type="text" placeholder="" style="width: 75px; height: 30px;">
			 			<br>
			 			<label for="review">Write Ur Review</label>
						<textarea id="review" style="width: 700px; height: 200px;"></textarea>
					</form>
					<button id="submitMovieReview" type="submit" class="btn" aria-hidden="true">Submit</button>
					<button id="cancelMovieReview" type="submit" class="btn" aria-hidden="true">Cancel</button>
					<br>
					<table id="urReviews" class="table table-hover">
						<thead>
							<tr><th> </th><th> Title </th><th>Grade</th><th>Year Released</th><th>Date Watched</th><th>Rating</th><th>Runtime</th></tr>
						</thead>
						<tbody id="movieTable">
							<tr>
								</td>
							</tr>
						</tbody>
					</table>

				</div> <!--End of div span12 box -->
			</div><!-- End of row -->
			 

		</div> <!-- End of container div -->

	</body>


</html>